#!/bin/bash

[ $# -ge 1 ] || {
  echo "usage: $(basename $0) <outdir> [<age>...]" 1>&2
  exit 1
}

topdir="$1"; shift
metric="DSC"
digits=5

ages=("$@")
if [ ${#ages[@]} -eq 0 ]; then
  ages=(36 37 38 39 40 41 42 43)
fi

c=0
for t1 in ${ages[@]}; do
  let t2="$t1+1"
  if [ $c -gt 0 ]; then
    echo -n ","
  fi
  echo -n "$t1-$t2"
  let c++
done
echo
for l in {1..87}; do
  c=0
  for t1 in ${ages[@]}; do
    let t2="$t1+1"
    if [ $c -gt 0 ]; then
      echo -n ","
    fi
    if [[ $metric == "CC" ]]; then
      tc=$(mirtk evaluate-similarity "$atlas/atlas/pbmaps/t$t1/structure_$l.nii.gz" \
                                     "$atlas/atlas/pbmaps/t$t2/structure_$l.nii.gz" \
                                     -metric $metric -table -noheader -noid -precision $digits)
    else
      tc=$(mirtk evaluate-overlap "$atlas/atlas/pbmaps/t$t1/structure_$l.nii.gz" \
                                  "$atlas/atlas/pbmaps/t$t2/structure_$l.nii.gz" \
                                  -probs -metric $metric -precision $digits)
    fi
    echo -n $tc
    let c++
  done
  echo
done
